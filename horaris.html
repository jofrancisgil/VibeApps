import React, { useState, useEffect } from 'react';
import { 
  Calendar, Users, BookOpen, Clock, Plus, Trash2, Save, 
  AlertCircle, Check, X, ChevronRight, ChevronLeft, 
  LayoutGrid, Download, Wand2, UserPlus, Ban, Coffee, Briefcase
} from 'lucide-react';

// --- UI Components ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, title = "" }) => {
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm",
    secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50",
    danger: "bg-rose-50 text-rose-600 border border-rose-200 hover:bg-rose-100",
    ghost: "text-slate-600 hover:bg-slate-100",
    success: "bg-emerald-600 text-white hover:bg-emerald-700",
    magic: "bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white hover:from-violet-700 hover:to-fuchsia-700 shadow-md"
  };
  return (
    <button 
      onClick={onClick} disabled={disabled} title={title}
      className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className}`}
    >
      {children}
    </button>
  );
};

const Input = ({ label, value, onChange, placeholder, type = "text", min, step, className="" }) => (
  <div className={`flex flex-col gap-1 w-full ${className}`}>
    {label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}
    <input
      type={type} min={min} step={step} value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
    />
  </div>
);

// --- APP PRINCIPAL ---
export default function App() {
  const [step, setStep] = useState(1);
  const [currentGrade, setCurrentGrade] = useState('1º'); 

  // --- DATOS INICIALES ---
  const [grades] = useState(['1º', '2º', '3º', '4º', '5º', '6º']);
  const [subjects, setSubjects] = useState(['Matemáticas', 'Lengua', 'Inglés', 'Conocim. Medio', 'Ed. Física', 'Música', 'Plástica', 'Religión/Valores']);
  
  const [timeSlots, setTimeSlots] = useState([
    { id: 't1', start: '09:00', end: '10:00', type: 'class' },
    { id: 't2', start: '10:00', end: '11:00', type: 'class' },
    { id: 'br1', start: '11:00', end: '11:30', type: 'break', name: 'Patio' },
    { id: 't3', start: '11:30', end: '12:30', type: 'class' },
    { id: 't4', start: '12:30', end: '13:30', type: 'class' },
    { id: 'br2', start: '13:30', end: '15:00', type: 'break', name: 'Comedor' },
    { id: 't5', start: '15:00', end: '15:45', type: 'class' },
    { id: 't6', start: '15:45', end: '16:30', type: 'class' },
  ]);

  const [days] = useState(['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes']);
  const [teachers, setTeachers] = useState([]);
  const [schedule, setSchedule] = useState({});

  // Estados Temporales / Modales
  const [isTeacherModalOpen, setIsTeacherModalOpen] = useState(false);
  const [editingTeacher, setEditingTeacher] = useState(null); 
  const [selectedCell, setSelectedCell] = useState(null); 
  
  // Inputs Temporales Configuración
  const [newSubject, setNewSubject] = useState('');
  const [newSlot, setNewSlot] = useState({ start: '', end: '', type: 'class', name: '' });
  
  // --- CARGA DE DATOS (PERSISTENCIA) ---
  useEffect(() => {
    const savedData = localStorage.getItem('cronosDataV3');
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        if(parsed.subjects) setSubjects(parsed.subjects);
        if(parsed.timeSlots) setTimeSlots(parsed.timeSlots);
        if(parsed.teachers) setTeachers(parsed.teachers);
        if(parsed.schedule) setSchedule(parsed.schedule);
      } catch (e) {
        console.error("Error cargando datos", e);
      }
    }
  }, []);

  const saveData = () => {
    const data = JSON.stringify({ teachers, schedule, subjects, timeSlots });
    localStorage.setItem('cronosDataV3', data);
    alert('Datos guardados correctamente en el navegador.');
  };

  // --- HELPERS CÁLCULO TIEMPO REAL ---

  // Convierte "HH:MM" a horas decimales (ej. "15:30" -> 15.5)
  const timeToDecimal = (timeStr) => {
    const [h, m] = timeStr.split(':').map(Number);
    return h + (m / 60);
  };

  // Calcula la duración de un slot en horas
  const getSlotDuration = (slotId) => {
    const slot = timeSlots.find(s => s.id === slotId);
    if (!slot) return 1; // Fallback
    const start = timeToDecimal(slot.start);
    const end = timeToDecimal(slot.end);
    return parseFloat((end - start).toFixed(2));
  };

  // Calcula carga del profesor sumando la duración real de cada clase asignada
  const getTeacherLoad = (teacherId) => {
    let totalHours = 0;
    Object.entries(schedule).forEach(([key, entry]) => {
      // Extraemos el slotId de la clave "grade-day-slotId"
      // Nota: slotId podría contener guiones (ej. "slot-123"), así que tomamos todo después del segundo guion
      const parts = key.split('-');
      const slotId = parts.slice(2).join('-');
      
      if (entry.mainTeacherId === teacherId || entry.supportTeacherId === teacherId) {
        totalHours += getSlotDuration(slotId);
      }
    });
    // Redondear a 2 decimales para evitar 12.0000001
    return parseFloat(totalHours.toFixed(2));
  };

  const isTeacherBusyAt = (teacherId, day, slotId) => {
    const isTeachingElsewhere = Object.entries(schedule).some(([key, entry]) => {
      const parts = key.split('-');
      // Reconstruimos day y slotId con cuidado
      const d = parts[1];
      const s = parts.slice(2).join('-');
      return d === day && s === slotId && (entry.mainTeacherId === teacherId || entry.supportTeacherId === teacherId);
    });
    const teacher = teachers.find(t => t.id === teacherId);
    const isUnavailable = teacher?.unavailable?.includes(`${day}-${slotId}`);
    return isTeachingElsewhere || isUnavailable;
  };

  // --- ACCIONES DE GESTIÓN ---

  const addTimeSlot = () => {
    if (newSlot.start && newSlot.end) {
      const id = `slot-${Date.now()}`;
      const slotToAdd = { ...newSlot, id };
      const updatedSlots = [...timeSlots, slotToAdd].sort((a, b) => a.start.localeCompare(b.start));
      setTimeSlots(updatedSlots);
      setNewSlot({ start: '', end: '', type: 'class', name: '' });
    }
  };

  const removeTimeSlot = (id) => {
    if(window.confirm("¿Seguro que quieres eliminar esta franja horaria? Se borrarán las clases asignadas.")) {
      // Filtrar slots
      const updatedSlots = timeSlots.filter(t => t.id !== id);
      setTimeSlots(updatedSlots);
      
      // Limpiar horario asociado de forma robusta
      const newSchedule = { ...schedule };
      Object.keys(newSchedule).forEach(key => {
        // La clave es grade-day-slotId. Verificamos si termina en el ID borrado.
        if (key.endsWith(`-${id}`)) {
          delete newSchedule[key];
        }
      });
      setSchedule(newSchedule);
    }
  };

  const handleSaveTeacher = (teacherData) => {
    if (editingTeacher) {
      setTeachers(teachers.map(t => t.id === teacherData.id ? teacherData : t));
    } else {
      const colors = ['bg-blue-100 text-blue-800', 'bg-emerald-100 text-emerald-800', 'bg-amber-100 text-amber-800', 'bg-rose-100 text-rose-800', 'bg-violet-100 text-violet-800', 'bg-cyan-100 text-cyan-800'];
      const randomColor = colors[teachers.length % colors.length];
      setTeachers([...teachers, { ...teacherData, id: Date.now(), color: randomColor }]);
    }
    setIsTeacherModalOpen(false);
    setEditingTeacher(null);
  };

  const handleDeleteTeacher = (id) => {
    if(window.confirm("¿Eliminar este profesor y todas sus clases asignadas?")) {
      setTeachers(teachers.filter(t => t.id !== id));
      const newSchedule = { ...schedule };
      Object.keys(newSchedule).forEach(key => {
        if (newSchedule[key].mainTeacherId === id || newSchedule[key].supportTeacherId === id) {
          delete newSchedule[key];
        }
      });
      setSchedule(newSchedule);
    }
  };

  const assignClass = (subject, mainTeacherId, supportTeacherId) => {
    if (!selectedCell) return;
    const key = `${selectedCell.grade}-${selectedCell.day}-${selectedCell.slotId}`;
    setSchedule({
      ...schedule,
      [key]: { subject, mainTeacherId, supportTeacherId }
    });
    setSelectedCell(null);
  };

  const clearCell = (grade, day, slotId) => {
    const key = `${grade}-${day}-${slotId}`;
    const newSchedule = { ...schedule };
    delete newSchedule[key];
    setSchedule(newSchedule);
  };

  // --- ALGORITMO AUTO-GENERACIÓN ---
  const autoGenerateSchedule = () => {
    if (!window.confirm("Esto intentará rellenar los huecos vacíos automáticamente. ¿Continuar?")) return;

    let newSchedule = { ...schedule };
    let changesMade = 0;
    
    // Calcular cargas actuales
    let tempTeacherLoads = {};
    teachers.forEach(t => tempTeacherLoads[t.id] = getTeacherLoad(t.id));

    const slots = timeSlots.filter(s => s.type === 'class');

    // Mezclar orden de procesamiento para variedad
    const shuffledGrades = [...grades].sort(() => Math.random() - 0.5);
    const shuffledDays = [...days].sort(() => Math.random() - 0.5);

    shuffledGrades.forEach(grade => {
      shuffledDays.forEach(day => {
        slots.forEach(slot => {
          const key = `${grade}-${day}-${slot.id}`;
          if (newSchedule[key]) return; // Ya ocupado

          const duration = getSlotDuration(slot.id);

          const availableTeachers = teachers.filter(t => {
            const currentLoad = tempTeacherLoads[t.id];
            const isAssignedToGrade = t.assignedGrades.includes(grade);
            const isAvailable = !t.unavailable.includes(`${day}-${slot.id}`);
            
            // Verificamos si ya da clase en OTRO curso a esta misma hora (en el nuevo horario simulado)
            const isBusyNow = Object.entries(newSchedule).some(([k, entry]) => {
              const parts = k.split('-');
              const d = parts[1];
              const s = parts.slice(2).join('-');
              return d === day && s === slot.id && (entry.mainTeacherId === t.id);
            });

            // Usamos maxLectivas y sumamos la duración del slot actual
            return isAssignedToGrade && (currentLoad + duration) <= t.maxLectivas && isAvailable && !isBusyNow;
          });

          // Elegir uno aleatorio
          if (availableTeachers.length > 0) {
            const selectedTeacher = availableTeachers[Math.floor(Math.random() * availableTeachers.length)];
            const subject = selectedTeacher.subjects[Math.floor(Math.random() * selectedTeacher.subjects.length)];
            
            newSchedule[key] = {
              subject: subject,
              mainTeacherId: selectedTeacher.id,
              supportTeacherId: null 
            };
            tempTeacherLoads[selectedTeacher.id] += duration;
            changesMade++;
          }
        });
      });
    });

    setSchedule(newSchedule);
    alert(`Generación completada. Se asignaron ${changesMade} clases nuevas.`);
  };

  // --- COMPONENTES RENDER ---

  const TeacherModal = () => {
    if (!isTeacherModalOpen) return null;
    
    const [tData, setTData] = useState(editingTeacher || {
      name: '', 
      maxLectivas: 20, 
      maxNoLectivas: 5, 
      subjects: [], 
      assignedGrades: [], 
      unavailable: []
    });

    const toggleSubject = (s) => {
      const newSubs = tData.subjects.includes(s) ? tData.subjects.filter(i => i !== s) : [...tData.subjects, s];
      setTData({...tData, subjects: newSubs});
    };

    const toggleGrade = (g) => {
      const newGrades = tData.assignedGrades.includes(g) ? tData.assignedGrades.filter(i => i !== g) : [...tData.assignedGrades, g];
      setTData({...tData, assignedGrades: newGrades});
    };

    const toggleUnavailable = (day, slotId) => {
      const key = `${day}-${slotId}`;
      const newUn = tData.unavailable.includes(key) ? tData.unavailable.filter(k => k !== key) : [...tData.unavailable, key];
      setTData({...tData, unavailable: newUn});
    };

    return (
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl animate-in zoom-in-95">
          <div className="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 className="text-xl font-bold text-slate-800">
              {editingTeacher ? 'Editar Profesor' : 'Nuevo Profesor'}
            </h3>
            <button onClick={() => setIsTeacherModalOpen(false)}><X size={24} className="text-slate-400 hover:text-slate-600" /></button>
          </div>
          
          <div className="p-6 space-y-8">
            <div className="grid md:grid-cols-2 gap-6">
              <Input label="Nombre" value={tData.name} onChange={v => setTData({...tData, name: v})} placeholder="Ej. Ana Martínez" />
              
              <div className="flex gap-4">
                <Input 
                  label="H. Lectivas (Clases)" 
                  type="number" 
                  step="0.25"
                  value={tData.maxLectivas} 
                  onChange={v => setTData({...tData, maxLectivas: parseFloat(v) || 0})} 
                  className="bg-indigo-50/50"
                />
                <Input 
                  label="H. No Lectivas (Otros)" 
                  type="number" 
                  step="0.25"
                  value={tData.maxNoLectivas} 
                  onChange={v => setTData({...tData, maxNoLectivas: parseFloat(v) || 0})} 
                  className="bg-slate-50"
                />
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold text-slate-700 mb-2">Materias Capacitado</label>
                <div className="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200 min-h-[80px]">
                  {subjects.map(s => (
                    <button key={s} onClick={() => toggleSubject(s)}
                      className={`text-xs px-2 py-1 rounded-md border ${tData.subjects.includes(s) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-300'}`}>
                      {s}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label className="block text-sm font-semibold text-slate-700 mb-2">Cursos Asignados</label>
                <div className="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200 min-h-[80px]">
                  {grades.map(g => (
                    <button key={g} onClick={() => toggleGrade(g)}
                      className={`text-xs px-2 py-1 rounded-md border ${tData.assignedGrades.includes(g) ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-slate-600 border-slate-300'}`}>
                      {g}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div>
              <div className="flex items-center gap-2 mb-2">
                <label className="text-sm font-semibold text-slate-700">Disponibilidad Horaria</label>
                <span className="text-xs text-slate-400 font-normal">(Marca en ROJO las horas donde NO se puede asignar clase lectiva)</span>
              </div>
              <div className="overflow-x-auto border border-slate-200 rounded-lg">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="bg-slate-50">
                      <th className="p-2 border-b">Hora</th>
                      {days.map(d => <th key={d} className="p-2 border-b">{d}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {timeSlots.map(slot => (
                      <tr key={slot.id}>
                        <td className="p-2 border-r bg-slate-50 font-mono text-xs text-slate-600">
                          {slot.start} - {slot.end}
                          <div className="text-[10px] text-slate-400 font-normal">{getSlotDuration(slot.id)}h</div>
                        </td>
                        {days.map(day => {
                          const isUnavailable = tData.unavailable.includes(`${day}-${slot.id}`);
                          const isBreak = slot.type === 'break';
                          return (
                            <td key={day} className="p-1 border border-slate-100 text-center">
                              {!isBreak ? (
                                <button 
                                  onClick={() => toggleUnavailable(day, slot.id)}
                                  className={`w-full h-8 rounded transition-colors ${isUnavailable ? 'bg-rose-100 text-rose-600 border border-rose-200' : 'bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}
                                >
                                  {isUnavailable ? <Ban size={16} className="mx-auto"/> : <Check size={16} className="mx-auto"/>}
                                </button>
                              ) : <span className="text-slate-300">-</span>}
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div className="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 sticky bottom-0">
            <Button variant="secondary" onClick={() => setIsTeacherModalOpen(false)}>Cancelar</Button>
            <Button onClick={() => handleSaveTeacher(tData)} disabled={!tData.name}>Guardar Profesor</Button>
          </div>
        </div>
      </div>
    );
  };

  const AssignModal = () => {
    if (!selectedCell) return null;
    const { grade, day, slotId } = selectedCell;
    const slotTime = timeSlots.find(t => t.id === slotId);
    const duration = getSlotDuration(slotId);

    const [selSubject, setSelSubject] = useState('');
    const [selMain, setSelMain] = useState('');
    const [selSupport, setSelSupport] = useState('');

    const availableTeachers = teachers.filter(t => {
      if (!t.assignedGrades.includes(grade)) return false;
      if (t.unavailable.includes(`${day}-${slotId}`)) return false;
      if (isTeacherBusyAt(t.id, day, slotId)) return false;
      return true;
    });

    const supportCandidates = availableTeachers.filter(t => t.id !== parseInt(selMain));

    return (
      <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md animate-in zoom-in-95">
          <div className="p-4 border-b flex justify-between items-center bg-indigo-600 text-white rounded-t-xl">
            <div>
              <h3 className="font-bold">Programar Clase - {grade}</h3>
              <p className="text-xs opacity-80">{day}, {slotTime?.start} - {slotTime?.end} ({duration}h)</p>
            </div>
            <button onClick={() => setSelectedCell(null)} className="hover:bg-white/20 p-1 rounded"><X size={20}/></button>
          </div>
          
          <div className="p-6 space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Materia</label>
              <select className="w-full p-2 border rounded-lg" value={selSubject} onChange={e => setSelSubject(e.target.value)}>
                <option value="">-- Seleccionar --</option>
                {subjects.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Profesor Principal</label>
              <select className="w-full p-2 border rounded-lg" value={selMain} onChange={e => setSelMain(e.target.value)} disabled={!selSubject}>
                <option value="">-- Seleccionar --</option>
                {availableTeachers
                  .filter(t => t.subjects.includes(selSubject))
                  .map(t => (
                    <option key={t.id} value={t.id}>{t.name} ({getTeacherLoad(t.id)}/{t.maxLectivas}h)</option>
                  ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1 flex justify-between">
                <span>Profesor de Refuerzo (Opcional)</span>
                <span className="text-xs text-slate-400 font-normal">Co-docencia</span>
              </label>
              <select className="w-full p-2 border rounded-lg bg-slate-50" value={selSupport} onChange={e => setSelSupport(e.target.value)} disabled={!selMain}>
                <option value="">-- Ninguno --</option>
                {supportCandidates.map(t => (
                   <option key={t.id} value={t.id}>{t.name} (Libre)</option>
                ))}
              </select>
            </div>
            
            <div className="pt-4">
               <Button className="w-full justify-center" disabled={!selMain || !selSubject} onClick={() => assignClass(selSubject, parseInt(selMain), selSupport ? parseInt(selSupport) : null)}>
                 Confirmar Asignación
               </Button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // --- RENDERIZADO PRINCIPAL ---

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
      <TeacherModal />
      <AssignModal />

      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div className="max-w-[1400px] mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 p-2 rounded-lg text-white"><Calendar size={20} /></div>
            <h1 className="text-xl font-bold text-slate-800 hidden sm:block">CronosEscolar <span className="text-indigo-600 text-sm font-normal px-2 py-0.5 bg-indigo-50 rounded-full border border-indigo-100">Pro</span></h1>
          </div>
          
          <div className="flex items-center gap-2">
             <div className="flex bg-slate-100 p-1 rounded-lg mr-4">
                <button onClick={() => setStep(1)} className={`px-3 py-1 text-sm rounded-md transition-all ${step === 1 ? 'bg-white shadow text-indigo-700 font-medium' : 'text-slate-500'}`}>Config</button>
                <button onClick={() => setStep(2)} className={`px-3 py-1 text-sm rounded-md transition-all ${step === 2 ? 'bg-white shadow text-indigo-700 font-medium' : 'text-slate-500'}`}>Profesores</button>
                <button onClick={() => setStep(3)} className={`px-3 py-1 text-sm rounded-md transition-all ${step === 3 ? 'bg-white shadow text-indigo-700 font-medium' : 'text-slate-500'}`}>Horario</button>
             </div>
             <Button variant="secondary" className="text-sm hidden md:flex" onClick={saveData}><Save size={16}/> Guardar</Button>
          </div>
        </div>
      </header>

      <main className="max-w-[1400px] mx-auto px-4 py-6">
        
        {/* PASO 1: CONFIGURACIÓN */}
        {step === 1 && (
          <div className="max-w-6xl mx-auto space-y-6 animate-in fade-in slide-in-from-bottom-2">
            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl flex gap-3 items-start">
              <div className="bg-blue-100 p-2 rounded-full text-blue-600"><BookOpen size={20}/></div>
              <div>
                <h3 className="font-bold text-blue-800">Paso 1: Configuración Global</h3>
                <p className="text-sm text-blue-600">Define las materias del centro y las franjas horarias de las clases.</p>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {/* Configuración de Materias */}
              <Card className="p-6 h-full">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                   <BookOpen size={18} className="text-indigo-600"/> Materias del Centro
                </h3>
                <div className="flex gap-2 mb-6">
                  <Input value={newSubject} onChange={setNewSubject} placeholder="Ej. Robótica..." />
                  <Button onClick={() => {
                    if(newSubject && !subjects.includes(newSubject)) {
                      setSubjects([...subjects, newSubject]);
                      setNewSubject('');
                    }
                  }}><Plus size={20}/></Button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {subjects.map(s => (
                    <div key={s} className="bg-white border border-slate-200 px-3 py-2 rounded-lg flex items-center gap-2 shadow-sm text-sm">
                      {s}
                      <button onClick={() => setSubjects(subjects.filter(sub => sub !== s))} className="text-slate-400 hover:text-rose-500"><X size={14}/></button>
                    </div>
                  ))}
                </div>
              </Card>

              {/* Configuración de Horarios */}
              <Card className="p-6 h-full">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                   <Clock size={18} className="text-indigo-600"/> Estructura Horaria
                </h3>
                
                {/* Añadir nuevo tramo */}
                <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4 grid grid-cols-12 gap-2 items-end">
                   <div className="col-span-3">
                     <label className="text-xs font-semibold text-slate-500">Inicio</label>
                     <input type="time" value={newSlot.start} onChange={e => setNewSlot({...newSlot, start: e.target.value})} className="w-full p-2 border rounded-md text-sm"/>
                   </div>
                   <div className="col-span-3">
                     <label className="text-xs font-semibold text-slate-500">Fin</label>
                     <input type="time" value={newSlot.end} onChange={e => setNewSlot({...newSlot, end: e.target.value})} className="w-full p-2 border rounded-md text-sm"/>
                   </div>
                   <div className="col-span-4">
                     <label className="text-xs font-semibold text-slate-500">Tipo</label>
                     <select 
                       value={newSlot.type} 
                       onChange={e => setNewSlot({...newSlot, type: e.target.value})}
                       className="w-full p-2 border rounded-md text-sm"
                     >
                       <option value="class">Clase Lectiva</option>
                       <option value="break">Descanso/Patio</option>
                     </select>
                   </div>
                   <div className="col-span-2">
                     <Button onClick={addTimeSlot} className="w-full justify-center" disabled={!newSlot.start || !newSlot.end}>
                       <Plus size={16}/>
                     </Button>
                   </div>
                </div>

                {/* Lista de tramos */}
                <div className="space-y-2 max-h-[400px] overflow-y-auto">
                   {timeSlots.map((slot, idx) => (
                     <div key={slot.id} className={`flex items-center justify-between p-3 rounded-lg border ${slot.type === 'break' ? 'bg-amber-50 border-amber-100' : 'bg-white border-slate-100'}`}>
                        <div className="flex items-center gap-3">
                           <span className="text-xs font-bold text-slate-400 w-6">#{idx+1}</span>
                           <div>
                              <div className="font-mono text-sm font-bold text-slate-700">
                                {slot.start} - {slot.end}
                              </div>
                              <div className="text-xs text-slate-500 flex items-center gap-1">
                                {slot.type === 'break' ? <Coffee size={10} className="text-amber-500"/> : <BookOpen size={10} className="text-indigo-500"/>}
                                {slot.type === 'break' ? (slot.name || 'Descanso') : `Clase Lectiva (${getSlotDuration(slot.id)}h)`}
                              </div>
                           </div>
                        </div>
                        <button 
                          onClick={(e) => { e.stopPropagation(); removeTimeSlot(slot.id); }} 
                          className="text-slate-300 hover:text-rose-500 p-2 hover:bg-rose-50 rounded-full transition-colors"
                          title="Eliminar franja"
                        >
                          <Trash2 size={16}/>
                        </button>
                     </div>
                   ))}
                </div>
              </Card>
            </div>
          </div>
        )}

        {/* PASO 2: PROFESORES */}
        {step === 2 && (
           <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
              <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-slate-800">Claustro de Profesores</h2>
                <Button onClick={() => { setEditingTeacher(null); setIsTeacherModalOpen(true); }}>
                  <UserPlus size={18}/> Nuevo Profesor
                </Button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {teachers.map(t => {
                   // Usamos t.maxLectivas
                   const load = getTeacherLoad(t.id);
                   const isOverloaded = load > t.maxLectivas;
                   return (
                     <div key={t.id} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all relative group">
                        <div className="flex justify-between items-start mb-3">
                           <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${t.color}`}>
                             {t.name.charAt(0)}
                           </div>
                           <div className="flex gap-1">
                             <button onClick={() => { setEditingTeacher(t); setIsTeacherModalOpen(true); }} className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded"><Users size={16}/></button>
                             <button onClick={() => handleDeleteTeacher(t.id)} className="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-slate-50 rounded"><Trash2 size={16}/></button>
                           </div>
                        </div>
                        <h4 className="font-bold text-slate-800 truncate">{t.name}</h4>
                        
                        <div className="mt-2 mb-3">
                          <div className="flex items-center justify-between text-xs mb-1">
                            <span className="text-slate-500">Lectivas</span>
                            <span className={`font-bold ${isOverloaded ? 'text-rose-600' : 'text-slate-700'}`}>{load}/{t.maxLectivas}h</span>
                          </div>
                          <div className="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden mb-2">
                             <div style={{width: `${Math.min((load/t.maxLectivas)*100, 100)}%`}} className={`h-full ${isOverloaded ? 'bg-rose-500' : 'bg-indigo-500'}`}></div>
                          </div>
                          <div className="flex items-center justify-between text-xs bg-slate-50 p-1.5 rounded">
                             <span className="text-slate-500 flex items-center gap-1"><Briefcase size={10}/> No Lectivas</span>
                             <span className="font-mono text-slate-700">{t.maxNoLectivas}h</span>
                          </div>
                        </div>

                        <div className="space-y-2">
                           <div className="flex flex-wrap gap-1">
                             {t.assignedGrades.map(g => <span key={g} className="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded border border-slate-200">{g}</span>)}
                           </div>
                           <div className="text-xs text-slate-400 truncate">
                             {t.subjects.join(', ')}
                           </div>
                        </div>
                     </div>
                   );
                })}
                {teachers.length === 0 && (
                  <div className="col-span-full py-12 text-center border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 text-slate-400">
                    <Users size={48} className="mx-auto mb-4 opacity-50"/>
                    <p>No hay profesores registrados. Añade uno para empezar.</p>
                  </div>
                )}
              </div>
           </div>
        )}

        {/* PASO 3: HORARIO */}
        {step === 3 && (
          <div className="h-[calc(100vh-140px)] flex flex-col animate-in fade-in slide-in-from-bottom-2">
            
            {/* Toolbar del Horario */}
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
               <div className="flex items-center gap-2 overflow-x-auto pb-1 sm:pb-0">
                  <span className="text-xs font-bold text-slate-400 uppercase mr-2">Curso:</span>
                  {grades.map(g => (
                    <button 
                      key={g} 
                      onClick={() => setCurrentGrade(g)}
                      className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${currentGrade === g ? 'bg-indigo-600 text-white shadow-md transform scale-105' : 'bg-slate-50 text-slate-600 hover:bg-slate-200'}`}
                    >
                      {g}
                    </button>
                  ))}
               </div>

               <div className="flex gap-2">
                  <Button variant="magic" onClick={autoGenerateSchedule} disabled={teachers.length === 0} title="Intenta rellenar huecos vacíos automáticamente">
                    <Wand2 size={18} className="animate-pulse"/> <span className="hidden md:inline">Auto-Rellenar</span>
                  </Button>
                  <Button variant="secondary" onClick={() => window.print()}><Download size={18}/></Button>
               </div>
            </div>

            {/* Grid del Horario */}
            <div className="flex-1 overflow-auto bg-white rounded-xl shadow border border-slate-200 relative">
               <table className="w-full min-w-[800px] border-collapse">
                 <thead className="sticky top-0 z-20 bg-white shadow-sm">
                   <tr>
                     <th className="p-4 bg-slate-50 border-b border-r border-slate-200 text-slate-500 w-24">Hora</th>
                     {days.map(d => <th key={d} className="p-4 bg-slate-50 border-b border-slate-200 text-slate-700 font-extrabold text-lg">{d}</th>)}
                   </tr>
                 </thead>
                 <tbody>
                   {timeSlots.map(slot => (
                     <tr key={slot.id} className={slot.type === 'break' ? 'bg-slate-50/50' : ''}>
                       <td className="p-3 border-r border-b border-slate-200 text-center sticky left-0 bg-white z-10">
                         <div className="font-mono text-sm font-bold text-slate-700">{slot.start}</div>
                         <div className="text-xs text-slate-400">{slot.end}</div>
                         {slot.type === 'break' && <span className="text-[10px] text-orange-500 font-bold uppercase mt-1 block tracking-wider">{slot.name || (slot.id.includes('1') ? 'Patio' : 'Comedor')}</span>}
                       </td>
                       {days.map(day => {
                         if (slot.type === 'break') {
                            return <td key={`${day}-${slot.id}`} className="bg-slate-100/50 border-b border-slate-200"></td>;
                         }

                         const key = `${currentGrade}-${day}-${slot.id}`;
                         const entry = schedule[key];
                         const mainTeacher = entry ? teachers.find(t => t.id === entry.mainTeacherId) : null;
                         const supportTeacher = entry && entry.supportTeacherId ? teachers.find(t => t.id === entry.supportTeacherId) : null;

                         return (
                           <td key={key} className="border-b border-r border-slate-100 p-1 h-32 w-[18%] align-top relative group transition-colors hover:bg-slate-50">
                              {entry ? (
                                <div className={`h-full w-full rounded-lg p-2 flex flex-col border shadow-sm ${mainTeacher ? mainTeacher.color.replace('text-', 'border-').replace('bg-', 'bg-opacity-20 ') : 'bg-gray-100'}`}>
                                   <div className="flex justify-between items-start mb-1">
                                      <span className="font-bold text-sm leading-tight text-slate-800">{entry.subject}</span>
                                      <button onClick={(e) => {e.stopPropagation(); clearCell(currentGrade, day, slot.id);}} className="text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14}/></button>
                                   </div>
                                   
                                   {/* Main Teacher */}
                                   <div className="mt-auto space-y-1">
                                      <div className="flex items-center gap-1.5 text-xs font-medium text-slate-700 bg-white/60 p-1 rounded">
                                        <Users size={12}/> {mainTeacher ? mainTeacher.name : 'Desconocido'}
                                      </div>
                                      {/* Support Teacher */}
                                      {supportTeacher && (
                                        <div className="flex items-center gap-1.5 text-[10px] font-medium text-indigo-700 bg-indigo-50 border border-indigo-100 p-1 rounded">
                                          <Plus size={10}/> Ref: {supportTeacher.name}
                                        </div>
                                      )}
                                   </div>
                                </div>
                              ) : (
                                <button 
                                  onClick={() => setSelectedCell({ grade: currentGrade, day, slotId: slot.id })}
                                  className="w-full h-full rounded-lg border-2 border-dashed border-slate-100 flex flex-col items-center justify-center text-slate-300 hover:text-indigo-500 hover:border-indigo-200 hover:bg-indigo-50 transition-all gap-2"
                                >
                                  <Plus size={24}/>
                                  <span className="text-xs font-medium opacity-0 group-hover:opacity-100">Asignar</span>
                                </button>
                              )}
                           </td>
                         );
                       })}
                     </tr>
                   ))}
                 </tbody>
               </table>
            </div>
          </div>
        )}
      </main>

       {/* CSS Styles for Print */}
       <style>{`
        @media print {
          header, button, .no-print { display: none !important; }
          body { background: white; }
          .shadow-sm, .shadow-md, .shadow-2xl { box-shadow: none !important; }
          td, th { border: 1px solid #ddd !important; }
          .bg-slate-50 { background-color: white !important; }
          main { height: auto !important; width: 100% !important; max-width: none !important; padding: 0 !important; }
          .overflow-auto { overflow: visible !important; }
          /* Forzar landscape si es posible o reducir escala */
          @page { size: landscape; }
        }
      `}</style>
    </div>
  );
}
